<?php
/**
 * Script de migration robuste vers le syst√®me de noms dual
 * Applique le syst√®me de noms dual √† toutes les d√©mos existantes
 */

// Configuration
error_reporting(E_ALL);
ini_set('display_errors', 1);
ini_set('log_errors', 1);

echo "üéØ Migration robuste vers le syst√®me de noms dual...\n";
echo "==================================================\n\n";

class RobustMigration {
    private $libraries = [
        'demospubliques/brouillon' => 'Brouillon',
        'demospubliques/prayers' => 'Prayers', 
        'demospubliques/bhajans' => 'Bhajans'
    ];
    
    private $backupDir = 'backups/';
    private $migrationLog = [];
    
    public function __construct() {
        // Cr√©er le dossier de backup
        if (!is_dir($this->backupDir)) {
            mkdir($this->backupDir, 0755, true);
        }
        
        // Cr√©er le fichier de log
        $this->migrationLog[] = "=== Migration d√©marr√©e le " . date('Y-m-d H:i:s') . " ===";
    }
    
    /**
     * G√©n√©rer un nom technique unique
     */
    private function generateTechnicalName($originalName = '') {
        $timestamp = time();
        $hash = substr(md5($originalName . $timestamp . uniqid()), 0, 8);
        return "demo_{$timestamp}_{$hash}";
    }
    
    /**
     * Extraire un nom d'affichage lisible
     */
    private function extractDisplayName($demo) {
        // Priorit√© 1: originalName
        if (!empty($demo['originalName'])) {
            return $this->cleanDisplayName($demo['originalName']);
        }
        
        // Priorit√© 2: name dans data
        if (isset($demo['data']['name']) && !empty($demo['data']['name'])) {
            return $this->cleanDisplayName($demo['data']['name']);
        }
        
        // Priorit√© 3: extraire du filename
        if (!empty($demo['filename'])) {
            return $this->extractNameFromFilename($demo['filename']);
        }
        
        // Fallback
        return 'D√©mo sans nom';
    }
    
    /**
     * Nettoyer un nom d'affichage
     */
    private function cleanDisplayName($name) {
        // Supprimer les extensions
        $name = preg_replace('/\.json$/', '', $name);
        
        // Supprimer les pr√©fixes techniques
        $name = preg_replace('/^demo_/', '', $name);
        
        // Nettoyer les caract√®res sp√©ciaux
        $name = preg_replace('/[^a-zA-Z0-9\s\-_]/', '', $name);
        
        // Remplacer les underscores par des espaces
        $name = str_replace('_', ' ', $name);
        
        // Capitaliser
        $name = ucwords(trim($name));
        
        // Limiter la longueur
        if (strlen($name) > 50) {
            $name = substr($name, 0, 47) . '...';
        }
        
        return $name ?: 'D√©mo sans nom';
    }
    
    /**
     * Extraire un nom du filename
     */
    private function extractNameFromFilename($filename) {
        // Supprimer l'extension
        $filename = str_replace('.json', '', $filename);
        
        // Supprimer le pr√©fixe demo_
        $filename = preg_replace('/^demo_/', '', $filename);
        
        // Extraire la partie descriptive (avant le premier timestamp)
        $parts = explode('_', $filename);
        $descriptiveParts = [];
        
        foreach ($parts as $part) {
            // Si c'est un timestamp (10+ chiffres) ou un ID hex (8+ caract√®res), arr√™ter
            if (is_numeric($part) && strlen($part) >= 10) {
                break;
            }
            if (strlen($part) >= 8 && ctype_xdigit($part)) {
                break;
            }
            $descriptiveParts[] = $part;
        }
        
        $name = implode(' ', $descriptiveParts);
        return $this->cleanDisplayName($name);
    }
    
    /**
     * Cr√©er un backup avant modification
     */
    private function createBackup($filepath) {
        $backupPath = $this->backupDir . basename($filepath) . '.backup.' . date('Y-m-d_H-i-s');
        
        if (file_exists($filepath)) {
            if (copy($filepath, $backupPath)) {
                $this->migrationLog[] = "‚úÖ Backup cr√©√©: " . basename($backupPath);
                return true;
            } else {
                $this->migrationLog[] = "‚ùå Erreur backup: " . $filepath;
                return false;
            }
        }
        return true; // Pas de fichier √† sauvegarder
    }
    
    /**
     * Migrer une biblioth√®que
     */
    public function migrateLibrary($libraryPath) {
        echo "\nüìÅ Migration de: $libraryPath\n";
        echo str_repeat('-', 50) . "\n";
        
        if (!is_dir($libraryPath)) {
            echo "‚ùå Dossier non trouv√©: $libraryPath\n";
            return false;
        }
        
        $indexFile = $libraryPath . '/index.json';
        if (!file_exists($indexFile)) {
            echo "‚ùå Fichier index.json non trouv√©: $indexFile\n";
            return false;
        }
        
        // Cr√©er un backup
        if (!$this->createBackup($indexFile)) {
            echo "‚ùå Impossible de cr√©er le backup\n";
            return false;
        }
        
        // Lire l'index
        $index = json_decode(file_get_contents($indexFile), true);
        if (!$index) {
            echo "‚ùå Erreur de lecture JSON: $indexFile\n";
            return false;
        }
        
        $updated = false;
        $demos = isset($index['demos']) ? $index['demos'] : $index;
        
        foreach ($demos as &$demo) {
            $originalDemo = $demo;
            
            // G√©n√©rer un nom technique si n√©cessaire
            if (empty($demo['technicalName'])) {
                $technicalName = $this->generateTechnicalName($demo['originalName'] ?? $demo['filename'] ?? '');
                $demo['technicalName'] = $technicalName;
                echo "  üîß Nom technique g√©n√©r√©: {$technicalName}\n";
                $updated = true;
            }
            
            // Extraire ou am√©liorer le nom d'affichage
            $displayName = $this->extractDisplayName($demo);
            
            // Mettre √† jour le nom d'affichage si n√©cessaire
            if (empty($demo['displayName']) || $demo['displayName'] !== $displayName) {
                $oldName = $demo['displayName'] ?? $demo['name'] ?? 'Sans nom';
                $demo['displayName'] = $displayName;
                $demo['name'] = $displayName; // Compatibilit√©
                echo "  üìù {$oldName} ‚Üí {$displayName}\n";
                $updated = true;
            }
            
            // Ajouter des m√©tadonn√©es utiles
            if (empty($demo['added'])) {
                $demo['added'] = $demo['created'] ?? date('c');
            }
            
            if (empty($demo['lastModified'])) {
                $demo['lastModified'] = date('c');
            }
            
            // S'assurer que le filename n'a pas de double extension
            if (isset($demo['filename']) && strpos($demo['filename'], '.json.json') !== false) {
                $cleanFilename = str_replace('.json.json', '.json', $demo['filename']);
                echo "  üîß Correction extension: {$demo['filename']} ‚Üí {$cleanFilename}\n";
                $demo['filename'] = $cleanFilename;
                $updated = true;
            }
        }
        
        // Mettre √† jour la structure si n√©cessaire
        if (isset($index['demos'])) {
            $index['demos'] = $demos;
        } else {
            $index = $demos;
        }
        
        // Ajouter des m√©tadonn√©es de migration
        $index['migration'] = [
            'version' => '2.0',
            'date' => date('c'),
            'system' => 'dual-names',
            'description' => 'Migration vers le syst√®me de noms dual'
        ];
        
        if ($updated) {
            // Sauvegarder l'index mis √† jour
            $result = file_put_contents($indexFile, json_encode($index, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
            
            if ($result !== false) {
                echo "‚úÖ Index mis √† jour: $indexFile\n";
                $this->migrationLog[] = "‚úÖ Migration r√©ussie: $libraryPath";
                return true;
            } else {
                echo "‚ùå Erreur d'√©criture: $indexFile\n";
                $this->migrationLog[] = "‚ùå Erreur d'√©criture: $libraryPath";
                return false;
            }
        } else {
            echo "‚ÑπÔ∏è Aucune modification n√©cessaire\n";
            $this->migrationLog[] = "‚ÑπÔ∏è Aucune modification: $libraryPath";
            return true;
        }
    }
    
    /**
     * Ex√©cuter la migration compl√®te
     */
    public function run() {
        echo "üöÄ D√©marrage de la migration robuste...\n\n";
        
        $successCount = 0;
        $totalCount = count($this->libraries);
        
        foreach ($this->libraries as $libraryPath => $libraryName) {
            if ($this->migrateLibrary($libraryPath)) {
                $successCount++;
            }
        }
        
        // Sauvegarder le log
        $this->saveLog();
        
        echo "\n" . str_repeat('=', 60) . "\n";
        echo "üéâ Migration termin√©e !\n";
        echo "‚úÖ Succ√®s: $successCount/$totalCount\n";
        echo "üìÅ Backups: " . $this->backupDir . "\n";
        echo "üìã Log: migration-log-" . date('Y-m-d_H-i-s') . ".txt\n";
        echo str_repeat('=', 60) . "\n";
        
        return $successCount === $totalCount;
    }
    
    /**
     * Sauvegarder le log de migration
     */
    private function saveLog() {
        $logFile = 'migration-log-' . date('Y-m-d_H-i-s') . '.txt';
        file_put_contents($logFile, implode("\n", $this->migrationLog));
    }
}

// Ex√©cuter la migration
try {
    $migration = new RobustMigration();
    $success = $migration->run();
    
    if ($success) {
        echo "\nüéØ Migration r√©ussie ! Le syst√®me de noms dual est maintenant actif.\n";
        echo "üìã Prochaines √©tapes:\n";
        echo "  1. Tester les fonctions de modification/d√©placement/suppression\n";
        echo "  2. V√©rifier l'affichage dans les interfaces\n";
        echo "  3. Tester la lecture des d√©mos\n";
    } else {
        echo "\n‚ö†Ô∏è Migration partielle. V√©rifiez les erreurs ci-dessus.\n";
    }
    
} catch (Exception $e) {
    echo "\n‚ùå Erreur critique: " . $e->getMessage() . "\n";
    echo "üìã V√©rifiez les logs pour plus de d√©tails.\n";
}
?>
